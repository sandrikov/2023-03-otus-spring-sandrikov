package ru.otus.homework;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.test.annotation.DirtiesContext;
import ru.otus.homework.quiz.dao.QuizResultRepository;
import ru.otus.homework.quiz.model.Student;
import ru.otus.homework.quiz.services.QuizService;
import ru.otus.homework.quiz.services.io.IOService;
import ru.otus.homework.quiz.services.io.IOServiceTestImpl;
import ru.otus.homework.quiz.services.localization.AppLocale;

import static java.util.Locale.ENGLISH;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.springframework.test.annotation.DirtiesContext.MethodMode.BEFORE_METHOD;

@SpringBootTest(properties = "spring.profiles.active=test")
class QuizAppEnTest {


    @DirtiesContext(methodMode = BEFORE_METHOD)
    @Test
    void testQuizService(@Autowired AppLocale appLocale, @Autowired QuizService quizService,
                         @Autowired QuizResultRepository dao) {
        appLocale.setLocale(ENGLISH);
        quizService.start();
        var results = dao.getResults(new Student("Tom", "Smith"));
        assertEquals(1, results.size(), "Expected the result of one test");
        var result = results.get(0);
        assertEquals(3, result.answers().size(), "Number of answers");
        assertFalse(result.answers().get(0).correct(), "1st answer is wrong");
        assertTrue(result.answers().get(1).correct(), "2nd answer is right");
        assertTrue(result.answers().get(2).correct(), "3rd answer is right");
        assertEquals(2, result.score(), "Result score");
        assertFalse(result.passed(), "Quiz failed");
    }

    @TestConfiguration
    static class ApplicationTestConfig {

        @Bean(name = "ioService")
        IOService getIOServiceEN(@Value("${application.io.silent}") boolean silent) {
            return new IOServiceTestImpl(silent,
                    "Smith",   // student only surname
                    "Tom Smith",      // student right input
                    // 1st question: choose-one-option
                    "",               // empty input
                    "9",              // answer wrong option
                    "2 4",            // answer more than one option
                    "3",              // wrong answer
                    // 2nd question: free text
                    "  \t",           // blank input
                    "Cat",            // right answer
                    // 3rd question: select-one-or-more-options
                    "\t ",            // blank input
                    "2 2",            // not unique
                    "3 1"             // right answer
            );
        }
    }
}
